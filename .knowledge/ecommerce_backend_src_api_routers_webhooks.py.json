{"is_source_file": true, "format": "Python", "description": "This file defines a FastAPI router for handling webhooks from payment providers such as Stripe. It includes data models for webhook acknowledgement, internal functions to map event types to transaction statuses, and an endpoint to process incoming webhook requests, verify them, and update transaction records accordingly.", "external_files": ["src.deps", "src.models", "src.models.enums", "src.services.payments"], "external_methods": ["verify_webhook"], "published": ["payments_webhook"], "classes": [{"name": "WebhookAck", "description": "Data model for acknowledging webhook processing, indicating receipt and verification status, with optional action, transaction ID, and notes."}], "methods": [{"name": "tuple[Optional[str],Optional[TransactionStatus]] _map_stripe_event_to_status(event: Dict[str, Any])", "description": "Maps Stripe-like event types to internal transaction statuses and retrieves the payment intent ID from event data.", "scope": "", "scopeKind": ""}, {"name": "WebhookAck payments_webhook( request: Request, stripe_signature: str | None = Header(default=None, alias=\"Stripe-Signature\"), db: Session = Depends(db_session), )", "description": "Main endpoint to handle incoming payment webhooks, verify authenticity, map event types to statuses, and update transactions accordingly.", "scope": "", "scopeKind": ""}], "calls": ["verify_webhook", "select", "Transaction.provider_payment_intent_id", "db.scalar", "db.add", "db.flush"], "search-terms": ["Stripe webhook handler", "transaction status mapping", "payment webhook endpoint", "APIRouter", "verify_webhook", "webhook signature", "Transaction", "provider_payment_intent_id"], "state": 2, "file_id": 45, "knowledge_revision": 121, "git_revision": "", "revision_history": [{"116": ""}, {"120": ""}, {"121": ""}], "ctags": [{"_type": "tag", "name": "WebhookAck", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^class WebhookAck(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_map_stripe_event_to_status", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^def _map_stripe_event_to_status(event: Dict[str, Any]) -> tuple[Optional[str], Optional[Transact/", "language": "Python", "typeref": "typename:tuple[Optional[str],Optional[TransactionStatus]]", "kind": "function", "signature": "(event: Dict[str, Any])"}, {"_type": "tag", "name": "action", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^    action: Optional[str] = Field(default=None, description=\"Action\\/status applied to the trans/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "WebhookAck", "scopeKind": "class"}, {"_type": "tag", "name": "note", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^    note: Optional[str] = Field(default=None, description=\"Additional notes\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "WebhookAck", "scopeKind": "class"}, {"_type": "tag", "name": "payments_webhook", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^async def payments_webhook($/", "language": "Python", "typeref": "typename:WebhookAck", "kind": "function", "signature": "( request: Request, stripe_signature: str | None = Header(default=None, alias=\"Stripe-Signature\"), db: Session = Depends(db_session), )"}, {"_type": "tag", "name": "received", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^    received: bool = Field(..., description=\"Whether the webhook was received and processed\")$/", "language": "Python", "typeref": "typename:bool", "kind": "variable", "scope": "WebhookAck", "scopeKind": "class"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^router = APIRouter(prefix=\"\\/webhooks\", tags=[\"webhooks\"])$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "transaction_id", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^    transaction_id: Optional[str] = Field(default=None, description=\"Transaction UUID affected (/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "WebhookAck", "scopeKind": "class"}, {"_type": "tag", "name": "verified", "path": "/home/kavia/workspace/code-generation/vintage-market-hub-176149-176159/ecommerce_backend/src/api/routers/webhooks.py", "pattern": "/^    verified: bool = Field(..., description=\"Whether the webhook payload signature was verified\"/", "language": "Python", "typeref": "typename:bool", "kind": "variable", "scope": "WebhookAck", "scopeKind": "class"}], "hash": "672859c36e8924a8f75d9563aabbd892", "format-version": 4, "code-base-name": "ecommerce_backend", "filename": "ecommerce_backend/src/api/routers/webhooks.py", "fields": [{"name": "Optional[str] action", "scope": "WebhookAck", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] note", "scope": "WebhookAck", "scopeKind": "class", "description": "unavailable"}, {"name": "bool received", "scope": "WebhookAck", "scopeKind": "class", "description": "unavailable"}, {"name": "router = APIRouter(prefix=\"\\/webhooks\", tags=[\"webhooks\"])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] transaction_id", "scope": "WebhookAck", "scopeKind": "class", "description": "unavailable"}, {"name": "bool verified", "scope": "WebhookAck", "scopeKind": "class", "description": "unavailable"}]}